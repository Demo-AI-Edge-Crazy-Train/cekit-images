#!/bin/sh

set -e

source "${JBOSS_CONTAINER_UTIL_LOGGING_MODULE}/logging.sh"
source "${JBOSS_CONTAINER_MAVEN_S2I_MODULE}/maven-s2i"

# include our s2i_core_*() overrides/extensions
source "${JBOSS_CONTAINER_JAVA_S2I_MODULE}/s2i-core-hooks"

# inject our overridden maven_s2i_*() functions
source "${JBOSS_CONTAINER_JAVA_S2I_MODULE}/maven-s2i-overrides"

# include our jlink scripts
source "${JBOSS_CONTAINER_JAVA_JLINK_MODULE}/mkdeps.sh"
source "${JBOSS_CONTAINER_JAVA_JLINK_MODULE}/mkstrippeddeps.sh"
source "${JBOSS_CONTAINER_JAVA_JLINK_MODULE}/generatejdkdeps.sh"
source "${JBOSS_CONTAINER_JAVA_JLINK_MODULE}/mkjreimage.sh"

# invoke the build
maven_s2i_build

echo "Checking that jarfile and libdir exist"
test -f "$JAVA_APP_JAR"
test -d "$JAVA_LIB_DIR"

echo "Invoking mkdeps"
generate_deps

echo "Stripping dependencies"
mkstrippeddeps

echo "Generating JDK dependencies"
generatejdkdeps

echo "Linking jre"
generate_jre_image